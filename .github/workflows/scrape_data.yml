# .github/workflows/scrape_data.yml

name: On-Demand OSM Scraper

on:
  # --- INICIO DE LA CORRECCIÓN ---
  # Eliminamos 'schedule'. Este workflow solo se activa por API.
  repository_dispatch:
    types: [scrape-for-user]
  # Mantenemos workflow_dispatch para pruebas manuales desde GitHub
  workflow_dispatch:
    inputs:
      user_id:
        description: 'User ID to scrape for (for manual runs)'
        required: true
  # --- FIN DE LA CORRECCIÓN ---
  

jobs:
  scrape-for-user:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # 3. Instala las dependencias de Python
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Instala las dependencias del navegador para Playwright
      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      # 5. Ejecuta el script de scraping
      - name: Run scraping script for user
        run: python run_update_for_user.py ${{ github.event.inputs.user_id || github.event.client_payload.user_id }}
        # Pasa los secretos de GitHub a las variables de entorno del script
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FIREBASE_ADMIN_JSON: ${{ secrets.FIREBASE_ADMIN_JSON }}


      - name: Upload Error Screenshots
        if: failure() || success()  # Ejecutar siempre, por si el script manejó el error internamente pero guardó la foto
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: |
            *.png
          if-no-files-found: ignore
          retention-days: 5

      - name: Send Discord Notification on Success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          # CORRECCIÓN: Usar 'webhook-url' en lugar de 'webhook'
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: "✅ **Scraper Diario de OSM completado con éxito!**"
          # CORRECCIÓN: Usar parámetros individuales para el embed
          embed-title: "Ver Ejecución en GitHub"
          embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-color: 65280 # Verde

      - name: Send Discord Notification on Failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          # CORRECCIÓN: Usar 'webhook-url'
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: "❌ **ERROR: El Scraper Diario de OSM falló!**"
          # CORRECCIÓN: Usar parámetros individuales
          embed-title: "Ver Logs del Error en GitHub"
          embed-description: "El proceso de scraping no se completó. Por favor, revisa los logs."
          embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-color: 16711680 # Rojo
